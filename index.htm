<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Facturación Peluquería Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; }
        .sidebar-item:hover { background: rgba(255,255,255,0.1); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            LayoutDashboard, Package, Users, Truck, ShoppingCart, 
            TrendingUp, Settings, Plus, Search, Edit2, Trash2, 
            FileText, Download, Upload, Save, X, ChevronRight,
            BarChart3, DollarSign, Percent, AlertCircle, CheckCircle
        } = lucide;
        const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } = Recharts;
        const { jsPDF } = window.jspdf;

        // ==================== DATOS INICIALES ====================
        const initialData = {
            empresa: {
                nombre: "Distribuciones Peluquería Pro S.L.",
                cif: "B12345678",
                direccion: "Calle Mayor 123, 28001 Madrid",
                telefono: "912345678",
                email: "info@peluqueriapro.es",
                serieFactura: "2026",
                contadorFactura: 1,
                iva: 21
            },
            productos: [
                { id: "1", ean: "8412345678901", nombre: "Champú Hidratante 500ml", marca: "L'Oréal", categoria: "Champús", precioCosteMedio: 8.50, precioVenta: 15.90, margen: 46.54, stock: 45, stockMinimo: 10 },
                { id: "2", ean: "8412345678902", nombre: "Acondicionador Reparador 300ml", marca: "Kerastase", categoria: "Acondicionadores", precioCosteMedio: 12.30, precioVenta: 24.50, margen: 49.80, stock: 23, stockMinimo: 8 },
                { id: "3", ean: "8412345678903", nombre: "Tinte Permanente 6.0", marca: "Wella", categoria: "Coloración", precioCosteMedio: 4.20, precioVenta: 9.90, margen: 57.58, stock: 67, stockMinimo: 20 },
                { id: "4", ean: "8412345678904", nombre: "Mascarilla Nutritiva 250ml", marca: "Moroccanoil", categoria: "Tratamientos", precioCosteMedio: 18.90, precioVenta: 35.00, margen: 46.00, stock: 5, stockMinimo: 5 },
                { id: "5", ean: "8412345678905", nombre: "Espuma Volumen 300ml", marca: "Schwarzkopf", categoria: "Estilizado", precioCosteMedio: 6.40, precioVenta: 12.50, margen: 48.80, stock: 34, stockMinimo: 12 }
            ],
            proveedores: [
                { id: "1", nombre: "L'Oréal Professionnel", cif: "A08000143", direccion: "Calle Alcobendas 10, Madrid", email: "pedidos@loreal.es", telefono: "917654321", descuentoHabitual: 15 },
                { id: "2", nombre: "Estética Pro S.A.", cif: "B87654321", direccion: "Av. Diagonal 456, Barcelona", email: "ventas@esteticapro.com", telefono: "932345678", descuentoHabitual: 10 }
            ],
            clientes: [
                { id: "1", nombre: "Peluquería Glamour", cif: "B11111111", direccion: "Calle Fuencarral 45, Madrid", email: "glamour@gmail.com", telefono: "912223344", descuentoHabitual: 5, formaPago: "Transferencia" },
                { id: "2", nombre: "Salón Belleza Total", cif: "B22222222", direccion: "Plaza Mayor 8, Madrid", email: "belleza@total.es", telefono: "913334455", descuentoHabitual: 0, formaPago: "Contado" }
            ],
            compras: [],
            ventas: [],
            logs: []
        };

        // ==================== COMPONENTES UI ====================
        const Button = ({ children, onClick, variant = "primary", className = "", disabled = false }) => {
            const baseStyles = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2 ";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-lg hover:shadow-xl",
                secondary: "bg-gray-200 text-gray-800 hover:bg-gray-300",
                danger: "bg-red-500 text-white hover:bg-red-600",
                success: "bg-green-500 text-white hover:bg-green-600",
                outline: "border-2 border-blue-600 text-blue-600 hover:bg-blue-50"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={baseStyles + variants[variant] + " " + className + (disabled ? " opacity-50 cursor-not-allowed" : "")}>
                    {children}
                </button>
            );
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover transition-all duration-300 ${className}`}>
                {children}
            </div>
        );

        const Input = ({ label, value, onChange, type = "text", placeholder = "" }) => (
            <div className="mb-4">
                {label && <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
                <input
                    type={type}
                    value={value}
                    onChange={(e) => onChange(type === "number" ? parseFloat(e.target.value) || 0 : e.target.value)}
                    placeholder={placeholder}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                />
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center p-6 border-b">
                            <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                                <X size={24} />
                            </button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        };

        // ==================== HOOK PRINCIPAL ====================
        const useERP = () => {
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem('erp_peluqueria_data');
                return saved ? JSON.parse(saved) : initialData;
            });
            const [activeModule, setActiveModule] = useState('dashboard');

            useEffect(() => {
                localStorage.setItem('erp_peluqueria_data', JSON.stringify(data));
            }, [data]);

            const addLog = (action, details) => {
                const newLog = {
                    id: Date.now(),
                    fecha: new Date().toISOString(),
                    action,
                    details
                };
                setData(prev => ({ ...prev, logs: [newLog, ...prev.logs].slice(0, 100) }));
            };

            const updateEmpresa = (empresa) => {
                setData(prev => ({ ...prev, empresa }));
                addLog('Configuración', 'Datos de empresa actualizados');
            };

            const addProducto = (producto) => {
                const newProducto = { ...producto, id: Date.now().toString(), margen: ((producto.precioVenta - producto.precioCosteMedio) / producto.precioVenta * 100).toFixed(2) };
                setData(prev => ({ ...prev, productos: [...prev.productos, newProducto] }));
                addLog('Producto', `Añadido: ${newProducto.nombre}`);
            };

            const updateProducto = (id, updates) => {
                setData(prev => ({
                    ...prev,
                    productos: prev.productos.map(p => p.id === id ? { ...p, ...updates, margen: ((updates.precioVenta || p.precioVenta - updates.precioCosteMedio || p.precioCosteMedio) / (updates.precioVenta || p.precioVenta) * 100).toFixed(2) } : p)
                }));
                addLog('Producto', `Actualizado: ${id}`);
            };

            const deleteProducto = (id) => {
                setData(prev => ({ ...prev, productos: prev.productos.filter(p => p.id !== id) }));
                addLog('Producto', `Eliminado: ${id}`);
            };

            const addCliente = (cliente) => {
                const newCliente = { ...cliente, id: Date.now().toString() };
                setData(prev => ({ ...prev, clientes: [...prev.clientes, newCliente] }));
                addLog('Cliente', `Añadido: ${newCliente.nombre}`);
            };

            const updateCliente = (id, updates) => {
                setData(prev => ({ ...prev, clientes: prev.clientes.map(c => c.id === id ? { ...c, ...updates } : c) }));
            };

            const deleteCliente = (id) => {
                setData(prev => ({ ...prev, clientes: prev.clientes.filter(c => c.id !== id) }));
            };

            const addProveedor = (proveedor) => {
                const newProveedor = { ...proveedor, id: Date.now().toString() };
                setData(prev => ({ ...prev, proveedores: [...prev.proveedores, newProveedor] }));
                addLog('Proveedor', `Añadido: ${newProveedor.nombre}`);
            };

            const addVenta = (venta) => {
                const numeroFactura = `${data.empresa.serieFactura}-${String(data.empresa.contadorFactura).padStart(4, '0')}`;
                const newVenta = { 
                    ...venta, 
                    id: Date.now().toString(), 
                    fecha: new Date().toISOString(),
                    numeroFactura 
                };
                
                setData(prev => {
                    const updatedProductos = prev.productos.map(p => {
                        const detalle = venta.detalles.find(d => d.productoId === p.id);
                        if (detalle) {
                            return { ...p, stock: p.stock - detalle.cantidad };
                        }
                        return p;
                    });
                    return { 
                        ...prev, 
                        productos: updatedProductos, 
                        ventas: [newVenta, ...prev.ventas],
                        empresa: { ...prev.empresa, contadorFactura: prev.empresa.contadorFactura + 1 }
                    };
                });
                addLog('Venta', `Factura: ${numeroFactura}`);
                return numeroFactura;
            };

            const exportarDatos = () => {
                const datos = { ...data, exportDate: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `erp_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                addLog('Backup', 'Datos exportados');
            };

            const importarDatos = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const datos = JSON.parse(e.target.result);
                        setData(datos);
                        addLog('Backup', 'Datos importados');
                        alert('Datos importados correctamente');
                    } catch (error) {
                        alert('Error al importar: archivo inválido');
                    }
                };
                reader.readAsText(file);
            };

            return {
                data,
                activeModule,
                setActiveModule,
                updateEmpresa,
                addProducto,
                updateProducto,
                deleteProducto,
                addCliente,
                updateCliente,
                deleteCliente,
                addProveedor,
                addVenta,
                exportarDatos,
                importarDatos
            };
        };

        // ==================== MÓDULOS ====================
        const Dashboard = ({ data }) => {
            const stats = useMemo(() => {
                const totalProductos = data.productos.length;
                const stockBajo = data.productos.filter(p => p.stock <= p.stockMinimo).length;
                const totalVentas = data.ventas.reduce((sum, v) => sum + v.total, 0);
                const totalCompras = data.compras.reduce((sum, c) => sum + c.total, 0);
                const beneficio = totalVentas - totalCompras;
                
                return { totalProductos, stockBajo, totalVentas, totalCompras, beneficio };
            }, [data]);

            const ventasPorMes = useMemo(() => {
                const meses = {};
                data.ventas.forEach(v => {
                    const mes = v.fecha.substring(0, 7);
                    meses[mes] = (meses[mes] || 0) + v.total;
                });
                return Object.entries(meses).map(([mes, total]) => ({ mes, total })).slice(-6);
            }, [data]);

            const productosTop = useMemo(() => {
                const ventasProd = {};
                data.ventas.forEach(v => {
                    v.detalles.forEach(d => {
                        ventasProd[d.productoNombre] = (ventasProd[d.productoNombre] || 0) + d.cantidad;
                    });
                });
                return Object.entries(ventasProd)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([nombre, cantidad]) => ({ nombre, cantidad }));
            }, [data]);

            const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884D8'];

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <Card className="bg-gradient-to-br from-blue-500 to-blue-600 text-white">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-blue-100 text-sm">Total Productos</p>
                                    <p className="text-3xl font-bold">{stats.totalProductos}</p>
                                </div>
                                <Package size={40} className="text-blue-200" />
                            </div>
                        </Card>
                        
                        <Card className={`${stats.stockBajo > 0 ? 'bg-gradient-to-br from-red-500 to-red-600' : 'bg-gradient-to-br from-green-500 to-green-600'} text-white`}>
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-white/80 text-sm">Stock Bajo</p>
                                    <p className="text-3xl font-bold">{stats.stockBajo}</p>
                                </div>
                                <AlertCircle size={40} className="text-white/60" />
                            </div>
                        </Card>
                        
                        <Card className="bg-gradient-to-br from-purple-500 to-purple-600 text-white">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-purple-100 text-sm">Ventas Totales</p>
                                    <p className="text-3xl font-bold">{stats.totalVentas.toFixed(2)}€</p>
                                </div>
                                <TrendingUp size={40} className="text-purple-200" />
                            </div>
                        </Card>
                        
                        <Card className={`bg-gradient-to-br ${stats.beneficio >= 0 ? 'from-green-500 to-green-600' : 'from-red-500 to-red-600'} text-white`}>
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-white/80 text-sm">Beneficio Neto</p>
                                    <p className="text-3xl font-bold">{stats.beneficio.toFixed(2)}€</p>
                                </div>
                                <DollarSign size={40} className="text-white/60" />
                            </div>
                        </Card>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <Card>
                            <h3 className="text-lg font-bold mb-4 text-gray-800">Evolución de Ventas</h3>
                            <ResponsiveContainer width="100%" height={300}>
                                <LineChart data={ventasPorMes}>
                                    <CartesianGrid strokeDasharray="3 3" />
                                    <XAxis dataKey="mes" />
                                    <YAxis />
                                    <Tooltip formatter={(value) => `${value.toFixed(2)}€`} />
                                    <Line type="monotone" dataKey="total" stroke="#8884d8" strokeWidth={2} />
                                </LineChart>
                            </ResponsiveContainer>
                        </Card>

                        <Card>
                            <h3 className="text-lg font-bold mb-4 text-gray-800">Productos Más Vendidos</h3>
                            <ResponsiveContainer width="100%" height={300}>
                                <BarChart data={productosTop}>
                                    <CartesianGrid strokeDasharray="3 3" />
                                    <XAxis dataKey="nombre" angle={-45} textAnchor="end" height={80} />
                                    <YAxis />
                                    <Tooltip />
                                    <Bar dataKey="cantidad" fill="#8884d8">
                                        {productosTop.map((entry, index) => (
                                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                        ))}
                                    </Bar>
                                </BarChart>
                            </ResponsiveContainer>
                        </Card>
                    </div>

                    {stats.stockBajo > 0 && (
                        <Card className="border-l-4 border-red-500 bg-red-50">
                            <h3 className="text-lg font-bold mb-2 text-red-800 flex items-center gap-2">
                                <AlertCircle size={20} />
                                Alertas de Stock
                            </h3>
                            <div className="space-y-2">
                                {data.productos.filter(p => p.stock <= p.stockMinimo).map(p => (
                                    <div key={p.id} className="flex justify-between items-center bg-white p-3 rounded-lg">
                                        <span className="font-medium">{p.nombre}</span>
                                        <span className="text-red-600 font-bold">Stock: {p.stock} (Mín: {p.stockMinimo})</span>
                                    </div>
                                ))}
                            </div>
                        </Card>
                    )}
                </div>
            );
        };

        const ProductosModule = ({ data, addProducto, updateProducto, deleteProducto }) => {
            const [search, setSearch] = useState('');
            const [modalOpen, setModalOpen] = useState(false);
            const [editing, setEditing] = useState(null);
            const [formData, setFormData] = useState({
                ean: '', nombre: '', marca: '', categoria: '',
                precioCosteMedio: 0, precioVenta: 0, stock: 0, stockMinimo: 0
            });

            const filteredProductos = data.productos.filter(p => 
                p.nombre.toLowerCase().includes(search.toLowerCase()) ||
                p.ean.includes(search) ||
                p.marca.toLowerCase().includes(search.toLowerCase())
            );

            const handleSubmit = (e) => {
                e.preventDefault();
                if (editing) {
                    updateProducto(editing.id, formData);
                } else {
                    addProducto(formData);
                }
                setModalOpen(false);
                setEditing(null);
                setFormData({ ean: '', nombre: '', marca: '', categoria: '', precioCosteMedio: 0, precioVenta: 0, stock: 0, stockMinimo: 0 });
            };

            const exportarExcel = () => {
                const ws = XLSX.utils.json_to_sheet(data.productos);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Productos");
                XLSX.writeFile(wb, "productos.xlsx");
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center gap-4 flex-1">
                            <div className="relative flex-1 max-w-md">
                                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
                                <input
                                    type="text"
                                    placeholder="Buscar por nombre, EAN o marca..."
                                    value={search}
                                    onChange={(e) => setSearch(e.target.value)}
                                    className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <Button variant="secondary" onClick={exportarExcel}>
                                <Download size={18} /> Exportar Excel
                            </Button>
                            <Button onClick={() => { setEditing(null); setModalOpen(true); }}>
                                <Plus size={18} /> Nuevo Producto
                            </Button>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                        <table className="w-full">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">EAN</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Marca</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">P. Coste</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">P. Venta</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Margen</th>
                                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Stock</th>
                                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {filteredProductos.map(producto => (
                                    <tr key={producto.id} className="hover:bg-gray-50">
                                        <td className="px-6 py-4 text-sm text-gray-900">{producto.ean}</td>
                                        <td className="px-6 py-4">
                                            <div className="text-sm font-medium text-gray-900">{producto.nombre}</div>
                                            <div className="text-sm text-gray-500">{producto.categoria}</div>
                                        </td>
                                        <td className="px-6 py-4 text-sm text-gray-900">{producto.marca}</td>
                                        <td className="px-6 py-4 text-sm text-right">{producto.precioCosteMedio.toFixed(2)}€</td>
                                        <td className="px-6 py-4 text-sm text-right font-medium">{producto.precioVenta.toFixed(2)}€</td>
                                        <td className="px-6 py-4 text-sm text-right">
                                            <span className={`px-2 py-1 rounded-full text-xs ${parseFloat(producto.margen) > 40 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                                                {producto.margen}%
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 text-center">
                                            <span className={`px-2 py-1 rounded-full text-xs ${producto.stock <= producto.stockMinimo ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
                                                {producto.stock}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 text-center">
                                            <button onClick={() => { setEditing(producto); setFormData(producto); setModalOpen(true); }} className="text-blue-600 hover:text-blue-900 mr-2">
                                                <Edit2 size={18} />
                                            </button>
                                            <button onClick={() => { if(confirm('¿Eliminar producto?')) deleteProducto(producto.id); }} className="text-red-600 hover:text-red-900">
                                                <Trash2 size={18} />
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title={editing ? "Editar Producto" : "Nuevo Producto"}>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="EAN / Código de barras" value={formData.ean} onChange={(v) => setFormData({...formData, ean: v})} />
                                <Input label="Nombre" value={formData.nombre} onChange={(v) => setFormData({...formData, nombre: v})} />
                                <Input label="Marca" value={formData.marca} onChange={(v) => setFormData({...formData, marca: v})} />
                                <Input label="Categoría" value={formData.categoria} onChange={(v) => setFormData({...formData, categoria: v})} />
                                <Input label="Precio Coste Medio (€)" type="number" step="0.01" value={formData.precioCosteMedio} onChange={(v) => setFormData({...formData, precioCosteMedio: v})} />
                                <Input label="Precio Venta (€)" type="number" step="0.01" value={formData.precioVenta} onChange={(v) => setFormData({...formData, precioVenta: v})} />
                                <Input label="Stock Actual" type="number" value={formData.stock} onChange={(v) => setFormData({...formData, stock: v})} />
                                <Input label="Stock Mínimo" type="number" value={formData.stockMinimo} onChange={(v) => setFormData({...formData, stockMinimo: v})} />
                            </div>
                            <div className="flex justify-end gap-2 pt-4">
                                <Button variant="secondary" onClick={() => setModalOpen(false)}>Cancelar</Button>
                                <Button type="submit">{editing ? 'Guardar Cambios' : 'Crear Producto'}</Button>
                            </div>
                        </form>
                    </Modal>
                </div>
            );
        };

        const VentasModule = ({ data, addVenta }) => {
            const [clienteId, setClienteId] = useState('');
            const [items, setItems] = useState([]);
            const [showPreview, setShowPreview] = useState(false);

            const addItem = () => {
                setItems([...items, { productoId: '', cantidad: 1, descuento: 0 }]);
            };

            const updateItem = (index, field, value) => {
                const newItems = [...items];
                newItems[index][field] = value;
                
                if (field === 'productoId') {
                    const producto = data.productos.find(p => p.id === value);
                    if (producto) {
                        newItems[index].productoNombre = producto.nombre;
                        newItems[index].precioUnitario = producto.precioVenta;
                    }
                }
                setItems(newItems);
            };

            const removeItem = (index) => {
                setItems(items.filter((_, i) => i !== index));
            };

            const calcularTotales = () => {
                const cliente = data.clientes.find(c => c.id === clienteId);
                const descuentoCliente = cliente ? cliente.descuentoHabitual : 0;
                
                let base = 0;
                items.forEach(item => {
                    const producto = data.productos.find(p => p.id === item.productoId);
                    if (producto) {
                        const precioConDescuento = item.precioUnitario * (1 - item.descuento / 100);
                        base += precioConDescuento * item.cantidad;
                    }
                });
                
                const descuentoTotal = base * (descuentoCliente / 100);
                const baseImponible = base - descuentoTotal;
                const iva = baseImponible * (data.empresa.iva / 100);
                const total = baseImponible + iva;
                
                return { base, descuentoTotal, baseImponible, iva, total, descuentoCliente };
            };

            const generarPDF = () => {
                const { total } = calcularTotales();
                const doc = new jsPDF();
                const cliente = data.clientes.find(c => c.id === clienteId);
                
                // Cabecera
                doc.setFillColor(102, 126, 234);
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.text(data.empresa.nombre, 20, 25);
                
                // Info empresa
                doc.setTextColor(100);
                doc.setFontSize(10);
                doc.text(`CIF: ${data.empresa.cif}`, 20, 50);
                doc.text(data.empresa.direccion, 20, 55);
                doc.text(`${data.empresa.telefono} | ${data.empresa.email}`, 20, 60);
                
                // Info cliente
                if (cliente) {
                    doc.setFontSize(12);
                    doc.setTextColor(0);
                    doc.text("FACTURA A:", 120, 50);
                    doc.setFontSize(10);
                    doc.text(cliente.nombre, 120, 57);
                    doc.text(`CIF: ${cliente.cif}`, 120, 64);
                    doc.text(cliente.direccion, 120, 71);
                }
                
                // Tabla de items
                let y = 90;
                doc.setFillColor(240);
                doc.rect(20, y, 170, 10, 'F');
                doc.setTextColor(0);
                doc.text("Producto", 25, y + 7);
                doc.text("Cant.", 100, y + 7);
                doc.text("P.Unit", 120, y + 7);
                doc.text("Dto.%", 140, y + 7);
                doc.text("Total", 170, y + 7);
                
                y += 15;
                items.forEach(item => {
                    doc.text(item.productoNombre.substring(0, 30), 25, y);
                    doc.text(item.cantidad.toString(), 100, y);
                    doc.text(item.precioUnitario.toFixed(2) + "€", 120, y);
                    doc.text(item.descuento + "%", 140, y);
                    const totalLinea = item.precioUnitario * item.cantidad * (1 - item.descuento/100);
                    doc.text(totalLinea.toFixed(2) + "€", 170, y);
                    y += 8;
                });
                
                // Totales
                y += 10;
                const totales = calcularTotales();
                doc.setDrawColor(200);
                doc.line(120, y, 190, y);
                doc.text("Base Imponible:", 130, y + 10);
                doc.text(totales.baseImponible.toFixed(2) + "€", 170, y + 10);
                doc.text(`IVA ${data.empresa.iva}%:`, 130, y + 18);
                doc.text(totales.iva.toFixed(2) + "€", 170, y + 18);
                doc.setFontSize(14);
                doc.setTextColor(102, 126, 234);
                doc.text("TOTAL:", 130, y + 30);
                doc.text(total.toFixed(2) + "€", 170, y + 30);
                
                doc.save(`factura_${Date.now()}.pdf`);
            };

            const handleGuardar = () => {
                const totales = calcularTotales();
                const venta = {
                    clienteId,
                    detalles: items.map(i => ({
                        productoId: i.productoId,
                        productoNombre: i.productoNombre,
                        cantidad: i.cantidad,
                        precioUnitario: i.precioUnitario,
                        descuento: i.descuento
                    })),
                    base: totales.baseImponible,
                    iva: totales.iva,
                    totalDescuento: totales.descuentoTotal,
                    total: totales.total
                };
                const numeroFactura = addVenta(venta);
                alert(`Factura ${numeroFactura} generada correctamente`);
                setClienteId('');
                setItems([]);
            };

            const totales = calcularTotales();

            return (
                <div className="space-y-6">
                    <Card>
                        <h3 className="text-lg font-bold mb-4">Nueva Factura de Venta</h3>
                        
                        <div className="mb-6">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                            <select 
                                value={clienteId} 
                                onChange={(e) => setClienteId(e.target.value)}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">Seleccionar cliente...</option>
                                {data.clientes.map(c => (
                                    <option key={c.id} value={c.id}>{c.nombre} {c.descuentoHabitual > 0 && `(-${c.descuentoHabitual}%)`}</option>
                                ))}
                            </select>
                        </div>

                        <div className="space-y-4">
                            {items.map((item, index) => (
                                <div key={index} className="flex gap-4 items-end bg-gray-50 p-4 rounded-lg">
                                    <div className="flex-1">
                                        <label className="block text-xs text-gray-600 mb-1">Producto</label>
                                        <select 
                                            value={item.productoId}
                                            onChange={(e) => updateItem(index, 'productoId', e.target.value)}
                                            className="w-full px-3 py-2 border rounded-lg text-sm"
                                        >
                                            <option value="">Seleccionar...</option>
                                            {data.productos.map(p => (
                                                <option key={p.id} value={p.id}>{p.nombre} ({p.stock} uds)</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="w-24">
                                        <label className="block text-xs text-gray-600 mb-1">Cantidad</label>
                                        <input 
                                            type="number" 
                                            min="1"
                                            value={item.cantidad}
                                            onChange={(e) => updateItem(index, 'cantidad', parseInt(e.target.value) || 1)}
                                            className="w-full px-3 py-2 border rounded-lg text-sm"
                                        />
                                    </div>
                                    <div className="w-24">
                                        <label className="block text-xs text-gray-600 mb-1">Dto. %</label>
                                        <input 
                                            type="number" 
                                            min="0" max="100"
                                            value={item.descuento}
                                            onChange={(e) => updateItem(index, 'descuento', parseFloat(e.target.value) || 0)}
                                            className="w-full px-3 py-2 border rounded-lg text-sm"
                                        />
                                    </div>
                                    <div className="w-32">
                                        <label className="block text-xs text-gray-600 mb-1">Precio</label>
                                        <div className="px-3 py-2 bg-gray-200 rounded-lg text-sm font-medium">
                                            {item.precioUnitario?.toFixed(2) || '0.00'}€
                                        </div>
                                    </div>
                                    <button onClick={() => removeItem(index)} className="text-red-500 hover:text-red-700 mb-2">
                                        <Trash2 size={18} />
                                    </button>
                                </div>
                            ))}
                        </div>

                        <Button onClick={addItem} variant="outline" className="mt-4">
                            <Plus size={18} /> Añadir Línea
                        </Button>

                        {items.length > 0 && (
                            <div className="mt-6 bg-gray-50 p-6 rounded-xl">
                                <div className="space-y-2 text-right">
                                    <div className="flex justify-between text-sm">
                                        <span>Base:</span>
                                        <span>{totales.base.toFixed(2)}€</span>
                                    </div>
                                    {totales.descuentoCliente > 0 && (
                                        <div className="flex justify-between text-sm text-green-600">
                                            <span>Dto. Cliente ({totales.descuentoCliente}%):</span>
                                            <span>-{totales.descuentoTotal.toFixed(2)}€</span>
                                        </div>
                                    )}
                                    <div className="flex justify-between text-sm">
                                        <span>Base Imponible:</span>
                                        <span>{totales.baseImponible.toFixed(2)}€</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span>IVA ({data.empresa.iva}%):</span>
                                        <span>{totales.iva.toFixed(2)}€</span>
                                    </div>
                                    <div className="flex justify-between text-xl font-bold pt-2 border-t">
                                        <span>TOTAL:</span>
                                        <span className="text-blue-600">{totales.total.toFixed(2)}€</span>
                                    </div>
                                </div>

                                <div className="flex justify-end gap-3 mt-6">
                                    <Button variant="secondary" onClick={generarPDF}>
                                        <FileText size={18} /> Ver PDF
                                    </Button>
                                    <Button onClick={handleGuardar}>
                                        <Save size={18} /> Guardar Factura
                                    </Button>
                                </div>
                            </div>
                        )}
                    </Card>
                </div>
            );
        };

        const ClientesModule = ({ data, addCliente, updateCliente, deleteCliente }) => {
            const [modalOpen, setModalOpen] = useState(false);
            const [editing, setEditing] = useState(null);
            const [formData, setFormData] = useState({ nombre: '', cif: '', direccion: '', email: '', telefono: '', descuentoHabitual: 0, formaPago: 'Transferencia' });

            const handleSubmit = (e) => {
                e.preventDefault();
                if (editing) {
                    updateCliente(editing.id, formData);
                } else {
                    addCliente(formData);
                }
                setModalOpen(false);
                setEditing(null);
                setFormData({ nombre: '', cif: '', direccion: '', email: '', telefono: '', descuentoHabitual: 0, formaPago: 'Transferencia' });
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800">Gestión de Clientes</h2>
                        <Button onClick={() => { setEditing(null); setModalOpen(true); }}>
                            <Plus size={18} /> Nuevo Cliente
                        </Button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {data.clientes.map(cliente => (
                            <Card key={cliente.id} className="relative">
                                <div className="absolute top-4 right-4 flex gap-2">
                                    <button onClick={() => { setEditing(cliente); setFormData(cliente); setModalOpen(true); }} className="text-blue-600 hover:text-blue-800">
                                        <Edit2 size={16} />
                                    </button>
                                    <button onClick={() => { if(confirm('¿Eliminar cliente?')) deleteCliente(cliente.id); }} className="text-red-600 hover:text-red-800">
                                        <Trash2 size={16} />
                                    </button>
                                </div>
                                <div className="flex items-start gap-4">
                                    <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                        <Users className="text-blue-600" size={24} />
                                    </div>
                                    <div className="flex-1">
                                        <h3 className="font-bold text-gray-800">{cliente.nombre}</h3>
                                        <p className="text-sm text-gray-500">{cliente.cif}</p>
                                        <p className="text-sm text-gray-600 mt-2">{cliente.direccion}</p>
                                        <div className="flex items-center gap-4 mt-3 text-sm text-gray-500">
                                            <span>{cliente.telefono}</span>
                                            <span>{cliente.email}</span>
                                        </div>
                                        <div className="mt-3 flex items-center gap-2">
                                            {cliente.descuentoHabitual > 0 && (
                                                <span className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                                    Dto. {cliente.descuentoHabitual}%
                                                </span>
                                            )}
                                            <span className="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">
                                                {cliente.formaPago}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </Card>
                        ))}
                    </div>

                    <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title={editing ? "Editar Cliente" : "Nuevo Cliente"}>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <Input label="Nombre" value={formData.nombre} onChange={(v) => setFormData({...formData, nombre: v})} />
                            <Input label="CIF/NIF" value={formData.cif} onChange={(v) => setFormData({...formData, cif: v})} />
                            <Input label="Dirección" value={formData.direccion} onChange={(v) => setFormData({...formData, direccion: v})} />
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="Email" value={formData.email} onChange={(v) => setFormData({...formData, email: v})} />
                                <Input label="Teléfono" value={formData.telefono} onChange={(v) => setFormData({...formData, telefono: v})} />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="Descuento Habitual %" type="number" value={formData.descuentoHabitual} onChange={(v) => setFormData({...formData, descuentoHabitual: v})} />
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Forma de Pago</label>
                                    <select 
                                        value={formData.formaPago}
                                        onChange={(e) => setFormData({...formData, formaPago: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    >
                                        <option>Transferencia</option>
                                        <option>Contado</option>
                                        <option>Tarjeta</option>
                                        <option>Recibo Domiciliado</option>
                                    </select>
                                </div>
                            </div>
                            <div className="flex justify-end gap-2 pt-4">
                                <Button variant="secondary" onClick={() => setModalOpen(false)}>Cancelar</Button>
                                <Button type="submit">{editing ? 'Guardar' : 'Crear'}</Button>
                            </div>
                        </form>
                    </Modal>
                </div>
            );
        };

        const ConfiguracionModule = ({ data, updateEmpresa, exportarDatos, importarDatos }) => {
            const [empresa, setEmpresa] = useState(data.empresa);

            const handleSave = () => {
                updateEmpresa(empresa);
                alert('Configuración guardada correctamente');
            };

            const handleImport = (e) => {
                if (e.target.files[0]) {
                    importarDatos(e.target.files[0]);
                }
            };

            return (
                <div className="space-y-6">
                    <Card>
                        <h3 className="text-lg font-bold mb-6 flex items-center gap-2">
                            <Settings size={20} />
                            Datos de la Empresa
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <Input label="Nombre Fiscal" value={empresa.nombre} onChange={(v) => setEmpresa({...empresa, nombre: v})} />
                            <Input label="CIF/NIF" value={empresa.cif} onChange={(v) => setEmpresa({...empresa, cif: v})} />
                            <Input label="Dirección" value={empresa.direccion} onChange={(v) => setEmpresa({...empresa, direccion: v})} />
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="Teléfono" value={empresa.telefono} onChange={(v) => setEmpresa({...empresa, telefono: v})} />
                                <Input label="Email" value={empresa.email} onChange={(v) => setEmpresa({...empresa, email: v})} />
                            </div>
                        </div>
                        
                        <div className="mt-6 pt-6 border-t">
                            <h4 className="font-medium mb-4">Configuración de Facturación</h4>
                            <div className="grid grid-cols-3 gap-4">
                                <Input label="Serie" value={empresa.serieFactura} onChange={(v) => setEmpresa({...empresa, serieFactura: v})} />
                                <Input label="Siguiente Número" type="number" value={empresa.contadorFactura} onChange={(v) => setEmpresa({...empresa, contadorFactura: v})} />
                                <Input label="IVA %" type="number" value={empresa.iva} onChange={(v) => setEmpresa({...empresa, iva: v})} />
                            </div>
                        </div>

                        <div className="mt-6 flex justify-end">
                            <Button onClick={handleSave}>
                                <Save size={18} /> Guardar Configuración
                            </Button>
                        </div>
                    </Card>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Card>
                            <h3 className="text-lg font-bold mb-4">Backup y Restauración</h3>
                            <div className="space-y-4">
                                <div className="p-4 bg-blue-50 rounded-lg">
                                    <p className="text-sm text-blue-800 mb-2">Exportar todos los datos a un archivo JSON</p>
                                    <Button onClick={exportarDatos} variant="secondary" className="w-full">
                                        <Download size={18} /> Exportar Datos
                                    </Button>
                                </div>
                                <div className="p-4 bg-yellow-50 rounded-lg">
                                    <p className="text-sm text-yellow-800 mb-2">Restaurar desde archivo de backup</p>
                                    <label className="flex items-center justify-center w-full px-4 py-2 border-2 border-dashed border-yellow-300 rounded-lg cursor-pointer hover:bg-yellow-100 transition-colors">
                                        <Upload size={18} className="mr-2 text-yellow-600" />
                                        <span className="text-yellow-700">Seleccionar archivo JSON</span>
                                        <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                                    </label>
                                </div>
                            </div>
                        </Card>

                        <Card>
                            <h3 className="text-lg font-bold mb-4">Información del Sistema</h3>
                            <div className="space-y-3 text-sm">
                                <div className="flex justify-between py-2 border-b">
                                    <span className="text-gray-600">Versión</span>
                                    <span className="font-medium">2.6.0</span>
                                </div>
                                <div className="flex justify-between py-2 border-b">
                                    <span className="text-gray-600">Productos registrados</span>
                                    <span className="font-medium">{data.productos.length}</span>
                                </div>
                                <div className="flex justify-between py-2 border-b">
                                    <span className="text-gray-600">Clientes</span>
                                    <span className="font-medium">{data.clientes.length}</span>
                                </div>
                                <div className="flex justify-between py-2 border-b">
                                    <span className="text-gray-600">Facturas emitidas</span>
                                    <span className="font-medium">{data.ventas.length}</span>
                                </div>
                                <div className="flex justify-between py-2">
                                    <span className="text-gray-600">Almacenamiento</span>
                                    <span className="font-medium text-green-600">Local (localStorage)</span>
                                </div>
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // ==================== APP PRINCIPAL ====================
        const App = () => {
            const erp = useERP();
            
            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard },
                { id: 'productos', label: 'Productos', icon: Package },
                { id: 'clientes', label: 'Clientes', icon: Users },
                { id: 'proveedores', label: 'Proveedores', icon: Truck },
                { id: 'ventas', label: 'Ventas', icon: ShoppingCart },
                { id: 'configuracion', label: 'Configuración', icon: Settings },
            ];

            const renderModule = () => {
                switch(erp.activeModule) {
                    case 'dashboard': return <Dashboard data={erp.data} />;
                    case 'productos': return <ProductosModule {...erp} />;
                    case 'clientes': return <ClientesModule {...erp} />;
                    case 'proveedores': return <ClientesModule data={{clientes: erp.data.proveedores}} addCliente={erp.addProveedor} updateCliente={()=>{}} deleteCliente={()=>{}} />;
                    case 'ventas': return <VentasModule {...erp} />;
                    case 'configuracion': return <ConfiguracionModule {...erp} />;
                    default: return <Dashboard data={erp.data} />;
                }
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Sidebar */}
                    <aside className="fixed left-0 top-0 h-full w-64 gradient-bg text-white shadow-2xl z-40">
                        <div className="p-6">
                            <h1 className="text-xl font-bold mb-1">ERP Peluquería</h1>
                            <p className="text-xs text-white/70">Sistema de Facturación Pro</p>
                        </div>
                        
                        <nav className="mt-6">
                            {menuItems.map(item => {
                                const Icon = item.icon;
                                return (
                                    <button
                                        key={item.id}
                                        onClick={() => erp.setActiveModule(item.id)}
                                        className={`w-full flex items-center gap-3 px-6 py-3 transition-all sidebar-item ${
                                            erp.activeModule === item.id ? 'bg-white/20 border-r-4 border-white' : 'text-white/80'
                                        }`}
                                    >
                                        <Icon size={20} />
                                        <span className="font-medium">{item.label}</span>
                                        {erp.activeModule === item.id && <ChevronRight size={16} className="ml-auto" />}
                                    </button>
                                );
                            })}
                        </nav>

                        <div className="absolute bottom-0 left-0 right-0 p-6">
                            <div className="bg-white/10 rounded-lg p-4">
                                <p className="text-xs text-white/70">Empresa:</p>
                                <p className="text-sm font-medium truncate">{erp.data.empresa.nombre}</p>
                                <p className="text-xs text-white/50 mt-1">Serie: {erp.data.empresa.serieFactura}</p>
                            </div>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="ml-64 p-8">
                        <div className="max-w-7xl mx-auto">
                            <div className="mb-8">
                                <h2 className="text-3xl font-bold text-gray-800">
                                    {menuItems.find(m => m.id === erp.activeModule)?.label}
                                </h2>
                                <p className="text-gray-500 mt-1">
                                    {new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                </p>
                            </div>
                            {renderModule()}
                        </div>
                    </main>
                </div>
            );
        };

        // Renderizar aplicación
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>